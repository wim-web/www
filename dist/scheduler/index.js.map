{"version":3,"sources":["../../src/log.ts","../../src/util/function.ts","../../src/scheduler/index.ts"],"sourcesContent":["import { createLogger, format, Logger, transports } from \"winston\";\n\nexport const noneLogger = (): Logger => {\n    return createLogger({\n        transports: [\n            new transports.Console({\n                silent: true\n            })\n        ]\n    })\n}\n\nexport const defaultLogger = (level: string): Logger => {\n    return createLogger({\n        level,\n        format: format.combine(\n            format.timestamp(),\n            format.json()\n        ),\n        transports: [\n            new transports.Console({\n                silent: false // ログ出力を有効化\n            })\n        ]\n    })\n}\n","export type SleepInput = {\n    h?: number,\n    m?: number,\n    s?: number,\n    ms?: number,\n}\n\nexport function calculateMilliseconds({\n    h, m, s, ms,\n}: SleepInput): number {\n    const toM = (h: number) => h * 60\n    const toS = (m: number) => m * 60\n    const toMS = (s: number) => s * 1000\n\n    return toMS(\n        toS(\n            toM(\n                h || 0\n            ) + (m || 0)\n        ) + (s || 0)\n    ) + (ms || 0)\n}\n\n","import { noneLogger } from \"@/log\"\nimport { Immediate } from \"@/timing\"\nimport { TimeConstraint, Timing } from \"@/timing/contract\"\nimport { calculateMilliseconds } from \"@/util/function\"\nimport { setTimeout } from \"timers/promises\"\nimport { a0 } from \"vitest/dist/chunks/reporters.WnPwkmgA.js\"\nimport { Logger } from \"winston\"\n\nexport type Mode = (ShotMode | LoopMode) & { _type: string }\n\nexport type ShotMode = {\n    _type: \"shot\"\n}\n\nexport type LoopMode = {\n    _type: \"loop\"\n    oneCycleTime: { h: number, m: number }\n}\n\ntype Filter<T extends string = string> = {\n    filtered: boolean,\n    items: T[]\n}\n\nexport class Scheduler<T extends string = string> {\n    private readonly logger: Logger\n\n    constructor(\n        private readonly mode: Mode,\n        private readonly timing: Timing,\n        private readonly tasks: Tasks<T>,\n        logger?: Logger,\n    ) {\n        this.logger = logger || noneLogger()\n    }\n\n    async run(filterItems: T[] = []): Promise<boolean> {\n        this.logger.debug(`run`, { mode: this.mode._type })\n\n        const filter: Filter<T> = filterItems.length === 0 ? { filtered: false, items: [] } : { filtered: true, items: filterItems }\n\n        switch (this.mode._type) {\n            case 'shot':\n                return await this.oneCycle(filter)\n            case 'loop':\n                return await this.loop(this.mode.oneCycleTime, filter)\n        }\n    }\n\n    private async oneCycle(filter: Filter): Promise<boolean> {\n        let isError = false\n\n        for (const task of this.tasks) {\n            if (filter.filtered && !filter.items.includes(task.name)) {\n                continue\n            }\n\n            this.logger.info(`start ${task.name}`, { task_name: task.name })\n            try {\n                const input = {\n                    key: task.name,\n                    date: new Date(),\n                }\n\n                if (!await this.timing.allow(input)) {\n                    this.logger.info(`skip ${task.name}`, { task_name: task.name })\n                    continue\n                }\n\n                await task.fn()\n                await this.timing.complete({\n                    ...input,\n                    constraint: task.constraint\n                })\n                this.logger.info(`end ${task.name}`, { task_name: task.name })\n            } catch (e) {\n                isError = true\n                this.logger.error(\"\", e)\n            }\n        }\n\n        return isError\n    }\n\n    // 最後のサイクルのみの結果を返す\n    private async loop(oneCycleTime: { h: number, m: number }, filter: Filter): Promise<boolean> {\n        // ループの最低時間\n        const totalSleepMs = calculateMilliseconds(oneCycleTime);\n        let running = true\n        const controller = new AbortController();\n\n        const signalHandle = () => {\n            running = false;  // ループを停止する\n            controller.abort(); // sleepを中断\n        }\n\n        process.on('SIGINT', () => {\n            signalHandle()\n        });\n        process.on('SIGTERM', () => {\n            signalHandle()\n        });\n        process.on('SIGQUIT', () => {\n            signalHandle()\n        });\n\n        let isError = false\n\n        try {\n            while (running) {\n                // スタート時刻を計測\n                const startTime = Date.now()\n                this.logger.debug(\"start oneCycle\")\n\n                isError = await this.oneCycle(filter)\n\n                const endTime = Date.now()\n                this.logger.debug(\"end oneCycle\")\n                const elapsedTime = endTime - startTime // 処理にかかった時間を計測\n\n                // 残り時間の計算\n                const remainingSleepTime = totalSleepMs - elapsedTime\n\n                if (remainingSleepTime > 0 && running) {\n                    this.logger.debug(\"sleep\", { sleep_time_ms: remainingSleepTime, sleep_time_s: remainingSleepTime / 1000, sleep_time_m: remainingSleepTime / (1000 * 60) })\n                    await setTimeout(remainingSleepTime, null, { signal: controller.signal }) // 残り時間をスリープ\n                }\n            }\n        } catch (e) {\n            if (e instanceof Error && e.name === \"AbortError\") {\n                // 正常なのでスルー\n                this.logger.debug(\"stopping\")\n            } else {\n                this.logger.error(\"\", e)\n                isError = true\n                throw e\n            }\n        }\n\n        return isError\n    }\n\n    async list(): Promise<{\n        [key: string]: string\n    }> {\n        return await this.timing.list()\n    }\n}\n\nexport type Task<T extends string = string> = {\n    name: T,\n    constraint: TimeConstraint,\n    fn: () => Promise<void>\n}\n\nexport type Tasks<T extends string = string> = Task<T>[]\n"],"mappings":"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","names":["h","m","s"]}